#! Generated by VisualDCT v2.6
#! DBDSTART
#! DBD("../../dbd/dlsPLC_vdct.dbd")
#! DBDEND


# vacuumValve.template
#% macro, __doc__, Template database for a vacuum valve with different interlocks for open and close operations
#% macro, device, device name
#% macro, vlvcc, device name of valve control crate
# % macro, port, asyn port name of FINS driver
#% macro, addr, First address in the DM variable range decade.  E.g. if valve is in DM150..159 then addr=150
#% macro, allowpv, If specified, then only write an open command when this is non-zero. MUST have CP at the end of it
#% macro, whylocked, String to output to EDM synoptic as to precisely why the device is locked and by whom
#% macro, timeout, Timeout in seconds for the FINS protocol
#% macro, ilk0, Interlock description 0
#% macro, ilk1, Interlock description 1
#% macro, ilk2, Interlock description 2
#% macro, ilk3, Interlock description 3
#% macro, ilk4, Interlock description 4
#% macro, ilk5, Interlock description 5
#% macro, ilk6, Interlock description 6
#% macro, ilk7, Interlock description 7
#% macro, ilk8, Interlock description 8
#% macro, ilk9, Interlock description 9
#% macro, ilk10, Interlock description 10
#% macro, ilk11, Interlock description 11
#% macro, ilk12, Interlock description 12
#% macro, ilk13, Interlock description 13
#% macro, ilk14, Interlock description 14
#% macro, ilk15, Interlock description 15
#% macro, cilk0, Gauge interlock description 0
#% macro, cilk1, Gauge interlock description 1
#% macro, cilk2, Gauge interlock description 2
#% macro, cilk3, Gauge interlock description 3
#% macro, cilk4, Gauge interlock description 4
#% macro, cilk5, Gauge interlock description 5
#% macro, cilk6, Gauge interlock description 6
#% macro, cilk7, Gauge interlock description 7
#% macro, cilk8, Gauge interlock description 8
#% macro, cilk9, Gauge interlock description 9
#% macro, cilk10, Gauge interlock description 10
#% macro, cilk11, Gauge interlock description 11
#% macro, cilk12, Gauge interlock description 12
#% macro, cilk13, Gauge interlock description 13
#% macro, cilk14, Gauge interlock description 14
#% macro, cilk15, Gauge interlock description 15
#% macro, con_label0, Label string for control value 0 (Optional - defaults to Open)
#% macro, con_label1, Label string for control value 1 (Optional - defaults to Close)
#% macro, con_label2, Label string for control value 2 (Optional - defaults to Reset)
#% macro, con_label3, Label string for control value 3 (Optional - defaults to "")
#% macro, con_label4, Label string for control value 4 (Optional - defaults to "")
#% macro, con_label5, Label string for control value 5 (Optional - defaults to "")
#% macro, con_label6, Label string for control value 6 (Optional - defaults to "")
#% macro, sta_label0, Label string for status value 0 (Optional - defaults to Fault)
#% macro, sta_label1, Label string for status value 1 (Optional - defaults to Open)
#% macro, sta_label2, Label string for status value 2 (Optional - defaults to Opening)
#% macro, sta_label3, Label string for status value 3 (Optional - defaults to Closed)
#% macro, sta_label4, Label string for status value 4 (Optional - defaults to Closing)
#% macro, sta_label5, Label string for status value 5 (Optional - defaults to "")
#% macro, sta_label6, Label string for status value 6 (Optional - defaults to "")
#% macro, sta_sv0, Optional. Defaults to MAJOR.     Alarm severity for status value 0.
#% macro, sta_sv1, Optional. Defaults to NO_ALARM.  Alarm severity for status value 1.
#% macro, sta_sv2, Optional. Defaults to NO_ALARM.  Alarm severity for status value 2.
#% macro, sta_sv3, Optional. Defaults to NO_ALARM.  Alarm severity for status value 3.
#% macro, sta_sv4, Optional. Defaults to NO_ALARM.  Alarm severity for status value 4.
#% macro, sta_sv5, Optional. Defaults to NO_ALARM.  Alarm severity for status value 5.
#% macro, sta_sv6, Optional. Defaults to NO_ALARM.  Alarm severity for status value 6.
#% macro, name, Object name and associated gui name
#% macro, gda_name, GDA name to export to gda as if it exists
#% macro, gda_desc, GDA description
#
# Bit pattern for Dx1: (IJG 8 Feb 2012)
#
# 15 14 13 12 11 10 09 08 07 06 05 04 03 02 01 00
#                        |  |        |  |  |     | LASTCON (0=Open, 1=Close, 2=Reset)
#                        |  |        |  |  |_____|
#                        |  |        |  |________  Open  Interlock Status (0=Failed, 1=OK)
#                        |  |        |___________  Close Interlock Status (0=Failed, 1=OK)
#                        |  |                    |
#                        |  |                    | STA (0=Fault, 1=Open, 2=Opening, 3=Closed, 4=Closing)
#                        |  |____________________|
#                        |_______________________  MODE (0=Operational, 1=Service)
#
# This associates an edm screen with the template
# % gui, $(name=), edm, vacuumValveBistable.edl, device=$(device)


# This associates BOY screens with the template
# % gui, $(name=), boydetail, dlsPLCApp_opi/vacValveBistable_detail.opi, device=$(device), DESC=$(device), ilk0=$(ilk0=unused),ilk1=$(ilk1=unused),ilk2=$(ilk2=unused),ilk3=$(ilk3=unused),ilk4=$(ilk4=unused),ilk5=$(ilk5=unused),ilk6=$(ilk6=unused),ilk7=$(ilk7=unused),ilk8=$(ilk8=unused),ilk9=$(ilk9=unused),ilk10=$(ilk10=unused),ilk11=$(ilk11=unused),ilk12=$(ilk12=unused),ilk13=$(ilk13=unused),ilk14=$(ilk14=unused),ilk15=$(ilk15=unused),cilk0=$(cilk0=unused),cilk1=$(cilk1=unused),cilk2=$(cilk2=unused),cilk3=$(cilk3=unused),cilk4=$(cilk4=unused),cilk5=$(cilk5=unused),cilk6=$(cilk6=unused),cilk7=$(cilk7=unused),cilk8=$(cilk8=unused),cilk9=$(cilk9=unused),cilk10=$(cilk10=unused),cilk11=$(cilk11=unused),cilk12=$(cilk12=unused),cilk13=$(cilk13=unused),cilk14=$(cilk14=unused),cilk15=$(cilk15=unused), name=$(name=), valvetype=$(valvetype=valve), valvetype=$(valvetype=valve)
# % gui, $(name=), boyembed, dlsPLCApp_opi/vacValveBistable_embed_box.opi, device=$(device), DESC=$(device), name=$(name=), valvetype=$(valvetype=valve)
# % gui, $(name=), boyembed, dlsPLCApp_opi/vacValveBistable_embed.opi, device=$(device), DESC=$(device), name=$(name=), valvetype=$(valvetype=valve)


# This tells the gui that we don't have debounce records
record(ai, "$(device):HASDEBOUNCE") {
  field(VAL, "0")
  field(PINI, "YES")
}

expand("dlsPLC_valveCtrl.vdb", valveCtrl) {
  macro(con_label0, "$(con_label0=Open)")
  macro(con_label1, "$(con_label1=Close)")
  macro(con_label2, "$(con_label2=Reset)")
  macro(con_label3, "$(con_label3=)")
  macro(con_label4, "$(con_label4=)")
  macro(con_label5, "$(con_label5=)")
  macro(con_label6, "$(con_label6=)")
  macro(sta_label0, "$(sta_label0=Fault)")
  macro(sta_label1, "$(sta_label1=Open)")
  macro(sta_label2, "$(sta_label2=Opening)")
  macro(sta_label3, "$(sta_label3=Closed)")
  macro(sta_label4, "$(sta_label4=Closing)")
  macro(sta_label5, "$(sta_label5=)")
  macro(sta_label6, "$(sta_label6=)")    
  macro(sta_sv0, "$(sta_sv0=MAJOR)")
  macro(sta_sv1, "$(sta_sv1=NO_ALARM)")
  macro(sta_sv2, "$(sta_sv2=NO_ALARM)")
  macro(sta_sv3, "$(sta_sv3=NO_ALARM)")
  macro(sta_sv4, "$(sta_sv4=NO_ALARM)")
  macro(sta_sv5, "$(sta_sv5=NO_ALARM)")
  macro(sta_sv6, "$(sta_sv6=NO_ALARM)")
  macro(donecalc,   "((A=D)&(((A*2+1)=B)|A=2|C=0))?0:1")
}

# Override LASTCON to be selected bits of $(addr)+1
record(mbbi, "$(device):LASTCON") {
  field(DESC, "Control Readback")
  field(DTYP, "Raw Soft Channel")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(TWVL, "2")
  field(NOBT, "2")
  field(SHFT, "0")
}

# Override STA to be selected bits of $(addr)+1
# NOTE: For mbbi bit shifting to work, it is important to set ZRVL, ONVL etc.
record(mbbi, "$(device):STA") {
  field(DTYP, "Raw Soft Channel")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(TWVL, "2")
  field(THVL, "3")
  field(FRVL, "4")
  field(FVVL, "5")
  field(SXVL, "6")
  field(NOBT, "3")
  field(SHFT, "4")
  field(INP, "$(device):GETLASTCON.VAL CP MS")  
}

# ###################################################################
# Open Interlock Status
# 
# % archiver 10 Monitor
# % controldesk Open Interlock Status smon
record(mbbi, "$(device):OPENILKSTA") {
  field(DESC, "Open Interlock Status")
  field(DTYP, "Raw Soft Channel")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(ZRST, "Failed")
  field(ONST, "Run Ilks OK")
  field(ZRSV, "MAJOR")
  field(ONSV, "NO_ALARM")
  field(NOBT, "1")
  field(SHFT, "2")
  field(INP, "$(device):GETLASTCON.VAL CP MS")  
}

# ###################################################################
# Close Interlock Status
# 
# % archiver 10 Monitor
# % controldesk Close Interlock Status smon
record(mbbi, "$(device):CLOSEILKSTA") {
  field(DESC, "Close Interlock Status")
  field(DTYP, "Raw Soft Channel")
  field(ZRVL, "0")
  field(ONVL, "1")
  field(ZRST, "Failed")
  field(ONST, "Run Ilks OK")
  field(ZRSV, "MAJOR")
  field(ONSV, "NO_ALARM")
  field(NOBT, "1")
  field(SHFT, "3")
  field(INP, "$(device):GETLASTCON.VAL CP MS")  
}

# Override GETOPS to get data from $(addr)+2 instead of $(addr)+4
record(calcout, "$(device):OPSINDX") {
  field(CALC, "$(addr)%100+2")
}

# Override MODSTA to be selected bits of $(decade)1
record(mbbiDirect, "$(device):MODSTA") {
  field(DTYP, "Raw Soft Channel")
  field(NOBT, "1")
  field(SHFT, "7")
  field(INP, "$(device):GETLASTCON.VAL CP MS")    
}

expand("dlsPLC_valveIlk.vdb", valveIlkOPEN) {
  macro(DIR, "OPEN")
  macro(ILK, "6")
  macro(INIILK, "7")
  macro(RAWILK, "8")
  macro(typeprefix, ":")
  macro(ilk0, "$(ilk0=unused)")
  macro(ilk1, "$(ilk1=unused)")
  macro(ilk2, "$(ilk2=unused)")
  macro(ilk3, "$(ilk3=unused)")
  macro(ilk4, "$(ilk4=unused)")
  macro(ilk5, "$(ilk5=unused)")
  macro(ilk6, "$(ilk6=unused)")
  macro(ilk7, "$(ilk7=unused)")
  macro(ilk8, "$(ilk8=unused)")
  macro(ilk9, "$(ilk9=unused)")
  macro(ilk10, "$(ilk10=unused)")
  macro(ilk11, "$(ilk11=unused)")
  macro(ilk12, "$(ilk12=unused)")
  macro(ilk13, "$(ilk13=unused)")
  macro(ilk14, "$(ilk14=unused)")
  macro(ilk15, "$(ilk15=unused)")
}

expand("dlsPLC_valveIlk.vdb", valveIlkCLOSE) {
  macro(DIR, "CLOSE")
  macro(ILK, "3")
  macro(INIILK, "4")
  macro(RAWILK, "5")
  macro(typeprefix, ":")
  macro(ilk0, "$(cilk0=unused)")
  macro(ilk1, "$(cilk1=unused)")
  macro(ilk2, "$(cilk2=unused)")
  macro(ilk3, "$(cilk3=unused)")
  macro(ilk4, "$(cilk4=unused)")
  macro(ilk5, "$(cilk5=unused)")
  macro(ilk6, "$(cilk6=unused)")
  macro(ilk7, "$(cilk7=unused)")
  macro(ilk8, "$(cilk8=unused)")
  macro(ilk9, "$(cilk9=unused)")
  macro(ilk10, "$(cilk10=unused)")
  macro(ilk11, "$(cilk11=unused)")
  macro(ilk12, "$(cilk12=unused)")
  macro(ilk13, "$(cilk13=unused)")
  macro(ilk14, "$(cilk14=unused)")
  macro(ilk15, "$(cilk15=unused)")
}

# Operational/Service Mode
#% archiver 10 Monitor
#% controldesk Mode smon
#
record(bi, "$(device):MODE") {
  field(DESC, "Mode")
  field(INP, "$(device):MODSTA.B0 CP MS")
  field(ZNAM, "$(mode1=Operational)")
  field(ONAM, "$(mode2=Service)")
}

#! Further lines contain data used by VisualDCT
#! View(1399,399,1.0)
#! Record("$(device):HASDEBOUNCE",1320,796,0,0,"$(device):HASDEBOUNCE")

#! TemplateInstance("valveCtrl",820,220,0,"")
#! TemplateField("valveCtrl","sta_label0",16777215,0,1)
#! TemplateField("valveCtrl","con_label6",16777215,0,1)
#! TemplateField("valveCtrl","con_label5",16777215,0,1)
#! TemplateField("valveCtrl","con_label4",16777215,0,1)
#! TemplateField("valveCtrl","sta_label6",16777215,0,1)
#! TemplateField("valveCtrl","con_label3",16777215,0,1)
#! TemplateField("valveCtrl","con_label2",16777215,0,1)
#! TemplateField("valveCtrl","sta_label5",16777215,0,1)
#! TemplateField("valveCtrl","con_label1",16777215,0,1)
#! TemplateField("valveCtrl","sta_label4",16777215,0,1)
#! TemplateField("valveCtrl","con_label0",16777215,0,1)
#! TemplateField("valveCtrl","sta_label3",16777215,0,1)
#! TemplateField("valveCtrl","sta_label2",16777215,0,1)
#! TemplateField("valveCtrl","sta_label1",16777215,0,1)

#! Record("$(device):LASTCON",300,1685,0,0,"$(device):LASTCON")
#! Field("$(device):LASTCON.RVAL",16777215,1,"$(device):LASTCON.RVAL")
#! Record("$(device):STA",800,1065,0,0,"$(device):STA")
#! Field("$(device):STA.RVAL",16777215,1,"$(device):STA.RVAL")
#! Record("$(device):OPENILKSTA",580,1685,0,0,"$(device):OPENILKSTA")
#! Field("$(device):OPENILKSTA.RVAL",16777215,1,"$(device):OPENILKSTA.RVAL")
#! Record("$(device):CLOSEILKSTA",880,1685,0,0,"$(device):CLOSEILKSTA")
#! Field("$(device):CLOSEILKSTA.RVAL",16777215,1,"$(device):CLOSEILKSTA.RVAL")
#! Record("$(device):GETOPS",480,1350,0,0,"$(device):GETOPS")
#! Record("$(device):MODSTA",1960,1222,0,0,"$(device):MODSTA")
#! Field("$(device):MODSTA.RVAL",16777215,0,"$(device):MODSTA.RVAL")
#! Field("$(device):MODSTA.B0",16777215,0,"$(device):MODSTA.B0")
#! Record("$(device):GETBITS",1520,1286,0,0,"$(device):GETBITS")
#! Field("$(device):GETBITS.FLNK",16777215,0,"$(device):GETBITS.FLNK")
#! Link("$(device):GETBITS.FLNK","$(device):FANBITS")
#! Field("$(device):GETBITS.INP",16777215,1,"$(device):GETBITS.INP")
#! Field("$(device):GETBITS.VAL",16777215,0,"$(device):GETBITS.VAL")
#! Record("$(device):FANBITS",1220,1352,0,1,"$(device):FANBITS")
#! Field("$(device):FANBITS.OUTA",16777215,0,"$(device):FANBITS.OUTA")
#! Link("$(device):FANBITS.OUTA","$(device):STA.RVAL")
#! Field("$(device):FANBITS.OUTB",16777215,0,"$(device):FANBITS.OUTB")
#! Link("$(device):FANBITS.OUTB","$(device):LASTCON.RVAL")
#! Field("$(device):FANBITS.OUTC",16777215,0,"$(device):FANBITS.OUTC")
#! Link("$(device):FANBITS.OUTC","$(device):OPENILKSTA.RVAL")
#! Field("$(device):FANBITS.OUTD",16777215,0,"$(device):FANBITS.OUTD")
#! Link("$(device):FANBITS.OUTD","$(device):CLOSEILKSTA.RVAL")
#! Field("$(device):FANBITS.OUTE",16777215,1,"$(device):FANBITS.OUTE")
#! Link("$(device):FANBITS.OUTE","$(device):MODSTA.RVAL")
#! Field("$(device):FANBITS.DOL",16777215,1,"$(device):FANBITS.DOL")
#! Link("$(device):FANBITS.DOL","$(device):GETBITS.VAL")

#! TemplateInstance("valveIlkOPEN",1760,200,0,"")
#! TemplateField("valveIlkOPEN","INIILK",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk9",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk15",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk8",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk14",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk7",16777215,0,1)
#! TemplateField("valveIlkOPEN","RAWILK",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk13",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk6",16777215,0,1)
#! TemplateField("valveIlkOPEN","ILK",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk12",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk5",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk11",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk4",16777215,0,1)
#! TemplateField("valveIlkOPEN","DIR",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk10",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk3",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk2",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk1",16777215,0,1)
#! TemplateField("valveIlkOPEN","ilk0",16777215,0,1)


#! TemplateInstance("valveIlkCLOSE",2000,200,0,"")
#! TemplateField("valveIlkCLOSE","INIILK",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk9",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk15",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk8",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk14",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk7",16777215,0,1)
#! TemplateField("valveIlkCLOSE","RAWILK",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk13",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk6",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ILK",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk12",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk5",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk11",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk4",16777215,0,1)
#! TemplateField("valveIlkCLOSE","DIR",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk10",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk3",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk2",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk1",16777215,0,1)
#! TemplateField("valveIlkCLOSE","ilk0",16777215,0,1)

#! Record("$(device):MODE",2220,1308,0,0,"$(device):MODE")
#! Field("$(device):MODE.INP",16777215,0,"$(device):MODE.INP")
#! Link("$(device):MODE.INP","$(device):MODSTA.B0")
