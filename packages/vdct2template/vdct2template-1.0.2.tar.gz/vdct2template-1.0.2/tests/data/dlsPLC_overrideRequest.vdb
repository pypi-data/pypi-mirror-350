#! Generated by VisualDCT v2.5
#! DBDSTART
#! DBD("../../dbd/interlock.dbd")
#! DBDEND

# % macro, __doc__, Template allowing override of individual interlock bits
# % macro, P, device prefix
# % macro, DESC, Description (e.g. DCM piezo override)
# % macro, PRESSURE1, Pressure in mbar that needs to be over setpoint to allow override
# % macro, PRESSURE2, Pressure in mbar that needs to be over setpoint to allow override
# % macro, SETPOINT, Setpoint in mbar that both pressures need to be higher than to allow override
# % macro, ONVAL, Interlock on value
# % macro, OFFVAL, Interlock off value
# % macro, outaddr, Output address (inaddr is outaddr + 1)
# % macro, port, The FINS port

template() {

  #! InputMacro(PRESSURE1,"",1400,980,16777215,1,false)
  #! InputMacro(PRESSURE2,"",1400,1000,16777215,1,false)
}

record(longout, "$(P):OUTPUT") {
  field(DESC, "Actual output to PLC")
  field(DTYP, "asynInt32")
  field(PRIO, "HIGH")
  field(OUT, "@asyn($(port), $(outaddr), $(timeout=0)) FINS_DM_WRITE")
}

### Main
record(bo, "$(P):TIMER") {
  field(DESC, "Timer for override message")
  field(SCAN, "5 second")
  field(DTYP, "Soft Channel")
  field(FLNK, "$(P):OUTPUT")
  field(VAL, "1")
}

### Individual
record(bo, "$(P):REQUEST") {
  field(DESC, "$(DESC)")
  field(DTYP, "Soft Channel")
  field(ZNAM, "Off")
  field(ONAM, "On")
}

### Individual
record(calcout, "$(P):OVERRIDE") {
  field(DESC, "Override-request state")
  field(DTYP, "Soft Channel")
  field(FLNK, "$(P):REMOVEREQUEST")
  field(CALC, "((A=1)&(B>D)&(C>D))?($(ONVAL)+1):($(OFFVAL)+1)")
  field(INPA, "$(P):REQUEST CP")
  field(INPB, "$(PRESSURE1) CP")
  field(OOPT, "On Change")
  field(OUT, "$(P):OUTPUT PP")
  field(INPC, "$(PRESSURE2) CP")
  field(INPD, "$(P):SETPOINT")
}

### Individual
record(calcout, "$(P):REMOVEREQUEST") {
  field(DESC, "Remove request on low P")
  field(DTYP, "Soft Channel")
  field(CALC, "(B>D)&&(C>D)&&(A#2)")
  field(INPA, "$(P):READBACK CP")
  field(OUT, "$(P):REQUEST.VAL PP")
  field(OOPT, "When Zero")
  field(INPB, "$(PRESSURE1)")
  field(INPC, "$(PRESSURE2)")
  field(INPD, "$(P):SETPOINT")
}

### Main
record(subArray, "$(P):GETINTERLOCKS") {
  field(DESC, "Get status")
  field(DTYP, "Soft Channel")
  field(INP, "$(vlvcc):BLOCK$(addr) CP")
  field(FLNK, "$(P):INTERLOCKS")
  field(FTVL, "USHORT")
  field(MALM, "100")
}

# INTERLOCKS read is in DM$(outaddr)+1. Calc the index into the
# century record
record(calcout, "$(P):INTERLOCKSINDX") {
  field(CALC, "$(outaddr)%100+1")
  field(OUT, "$(P):GETINTERLOCKS.INDX PP")
  field(PINI, "YES")
}

record(mbbiDirect, "$(P):INTERLOCKS") {
  field(DTYP, "Raw Soft Channel")
  field(INP, "$(P):GETINTERLOCKS.VAL")
}

# 0 = off
# 1 = 0n
# 2 = clearing
record(calc, "$(P):READBACK") {
  field(DESC, "Readback of state")
  field(CALC, "A+B")
  field(INPA, "$(P):INTERLOCKS.B$(ONVAL)")
  field(INPB, "$(P):INTERLOCKS.B$(OFFVAL)")
}

### Individual
record(ao, "$(P):SETPOINT") {
  field(DESC, "Cutoff press. for override")
  field(DTYP, "Soft Channel")
  field(VAL, "$(SETPOINT)")
}

#! Further lines contain data used by VisualDCT
#! View(575,166,0.5)
#! Record("$(P):OUTPUT",2160,732,0,0,"$(P):OUTPUT")
#! Field("$(P):OUTPUT.VAL",16777215,0,"$(P):OUTPUT.VAL")
#! Record("$(P):TIMER",1880,580,0,1,"$(P):TIMER")
#! Field("$(P):TIMER.FLNK",16777215,1,"$(P):TIMER.FLNK")
#! Link("$(P):TIMER.FLNK","$(P):OUTPUT")
#! Record("$(P):REQUEST",1300,832,0,0,"$(P):REQUEST")
#! Field("$(P):REQUEST.VAL",16777215,1,"$(P):REQUEST.VAL")
#! Record("$(P):OVERRIDE",1880,772,0,0,"$(P):OVERRIDE")
#! Field("$(P):OVERRIDE.INPA",16777215,0,"$(P):OVERRIDE.INPA")
#! Link("$(P):OVERRIDE.INPA","$(P):OVERRIDE/INPA")
#! Field("$(P):OVERRIDE.INPB",16777215,0,"$(P):OVERRIDE.INPB")
#! Link("$(P):OVERRIDE.INPB",PRESSURE1)
#! Field("$(P):OVERRIDE.INPC",16777215,0,"$(P):OVERRIDE.INPC")
#! Link("$(P):OVERRIDE.INPC",PRESSURE2)
#! Field("$(P):OVERRIDE.OUT",16777215,1,"$(P):OVERRIDE.OUT")
#! Link("$(P):OVERRIDE.OUT","$(P):OUTPUT.VAL")
#! Field("$(P):OVERRIDE.FLNK",16777215,1,"$(P):OVERRIDE.FLNK")
#! Link("$(P):OVERRIDE.FLNK","$(P):ILK$(BIT):OVERRIDE/FLNK")
#! Connector("$(P):ILK$(BIT):OVERRIDE/FLNK","$(P):REMOVEREQUEST",2100,1131,16777215,"",0)
#! Field("$(P):OVERRIDE.INPD",16777215,0,"$(P):OVERRIDE.INPD")
#! Link("$(P):OVERRIDE.INPD","$(P):OVERRIDE/INPD")
#! Connector("$(P):OVERRIDE/INPA","$(P):REQUEST.VAL",1800,960,16777215,"",0)
#! Connector("$(P):OVERRIDE/INPD","$(P):SETPOINT.VAL",1800,1110,16777215,"",0)
#! Record("$(P):REMOVEREQUEST",1880,1126,0,1,"$(P):REMOVEREQUEST")
#! Field("$(P):REMOVEREQUEST.OUT",16777215,0,"$(P):REMOVEREQUEST.OUT")
#! Link("$(P):REMOVEREQUEST.OUT","$(P):REMOVEREQUEST/OUT")
#! Field("$(P):REMOVEREQUEST.INPA",16777215,1,"$(P):REMOVEREQUEST.INPA")
#! Link("$(P):REMOVEREQUEST.INPA","$(P):READBACK.VAL")
#! Field("$(P):REMOVEREQUEST.INPB",16777215,0,"$(P):REMOVEREQUEST.INPB")
#! Link("$(P):REMOVEREQUEST.INPB","$(P):REMOVEREQUEST/INPB")
#! Field("$(P):REMOVEREQUEST.INPC",16777215,0,"$(P):REMOVEREQUEST.INPC")
#! Link("$(P):REMOVEREQUEST.INPC","$(P):REMOVEREQUEST/INPC")
#! Field("$(P):REMOVEREQUEST.INPD",16777215,0,"$(P):REMOVEREQUEST.INPD")
#! Link("$(P):REMOVEREQUEST.INPD","$(P):REMOVEREQUEST/INPD")
#! Connector("$(P):REMOVEREQUEST/OUT","$(P):REQUEST.VAL",1660,1130,16777215,"",0)
#! Connector("$(P):REMOVEREQUEST/INPB",PRESSURE1,1640,1170,16777215,"",0)
#! Connector("$(P):REMOVEREQUEST/INPC",PRESSURE2,1620,1190,16777215,"",0)
#! Connector("$(P):REMOVEREQUEST/INPD","$(P):SETPOINT.VAL",1600,1270,16777215,"",0)
#! Record("$(P):SUBARR",2180,1106,0,1,"$(P):SUBARR")
#! Field("$(P):SUBARR.INP",16777215,1,"$(P):SUBARR.INP")
#! Field("$(P):SUBARR.FLNK",16777215,1,"$(P):SUBARR.FLNK")
#! Link("$(P):SUBARR.FLNK","$(P):INTERLOCKS")
#! Field("$(P):SUBARR.VAL",16777215,1,"$(P):SUBARR.VAL")
#! Record("$(P):INTERLOCKS",2440,1166,0,0,"$(P):INTERLOCKS")
#! Field("$(P):INTERLOCKS.FLNK",16777215,1,"$(P):INTERLOCKS.FLNK")
#! Link("$(P):INTERLOCKS.FLNK","$(P):READBACK")
#! Field("$(P):INTERLOCKS.INP",16777215,0,"$(P):INTERLOCKS.INP")
#! Link("$(P):INTERLOCKS.INP","$(P):SUBARR.VAL")
#! Record("$(P):READBACK",2700,1212,0,0,"$(P):READBACK")
#! Field("$(P):READBACK.VAL",16777215,0,"$(P):READBACK.VAL")
#! Field("$(P):READBACK.INPA",16777215,0,"$(P):READBACK.INPA")
#! Field("$(P):READBACK.INPB",16777215,0,"$(P):READBACK.INPB")
#! Record("$(P):SETPOINT",1300,1046,0,1,"$(P):SETPOINT")
#! Field("$(P):SETPOINT.VAL",16777215,1,"$(P):SETPOINT.VAL")
#! Box(Box0,1280,740,1500,1200,0,16777215,null)
#! TextBox(TB0,1300,760,1460,800,0,"Dialog",24,1,16777215,"Inputs",null)
#! TextBox(TB1,2160,660,2460,700,0,"Dialog",24,1,16777215,"Output",null)
#! Box(Box1,2140,640,2340,900,0,16777215,null)
#! Box(Box2,2140,1000,2880,1420,0,16777215,null)
#! TextBox(TB2,2160,1020,2520,1080,0,"Dialog",24,1,16777215,"Readback",null)
