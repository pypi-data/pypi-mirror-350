utils={iOS:function(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document},isMobile:function(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e},displayMode:function(){var e=window.matchMedia("(display-mode: standalone)").matches;return document.referrer.startsWith("android-app://")?"twa":navigator.standalone||e?"standalone":"browser"},isApp:function(){return"standalone"===utils.displayMode()},isBrowser:function(){return!utils.isApp()},urlBase64ToUint8Array:function(e){e=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/");let t=window.atob(e),o=new Uint8Array(t.length);for(let e=0;e<t.length;++e)o[e]=t.charCodeAt(e);return o},loadVersionBrowser:function(){if("userAgentData"in navigator){var n=navigator.userAgentData;let t,o,a=null;for(var r=0;r<n.brands.length;r++){let e=n.brands[r].brand;if(o=n.brands[r].version,null!==e.match(/opera|chrome|edge|safari|firefox|msie|trident/i)){if(null===e.match(/chrome/i))return t=e.substr(e.indexOf(" ")+1),{name:t,version:o};a=o}}if(null!==a)return{name:"chrome",version:a}}let e=navigator.userAgent,t,o=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(o[1]))return{name:"IE",version:(/\brv[ :]+(\d+)/g.exec(e)||[])[1]||""};if("Chrome"===o[1]){var a=e.match(/\bOPR\/(\d+)/);if(null!=a)return{name:"Opera",version:a[1]}}return o=o[2]?[o[1],o[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(t=e.match(/version\/(\d+)/i))&&o.splice(1,1,t[1]),{name:o[0],version:o[1]}},setBadge:function(){navigator.setAppBadge?navigator.setAppBadge(arguments):navigator.setExperimentalAppBadge?navigator.setExperimentalAppBadge(arguments):window.ExperimentalBadge&&window.ExperimentalBadge.set(arguments)},clearBadge:function(){navigator.clearAppBadge?navigator.clearAppBadge():navigator.clearExperimentalAppBadge?navigator.clearExperimentalAppBadge():window.ExperimentalBadge&&window.ExperimentalBadge.clear()},closeNotification:function(){navigator.serviceWorker.ready.then(e=>{e.getNotifications().then(t=>{for(let e=0;e<t.length;e+=1)t[e].close()})})}};var smartConsole=function(e,t){var a=this;a.model=e,window.console&&t||(t={});var o=!1,n=!1,r={logs:[],errors:[],warns:[],infos:[]};return a.log=function(){var t=Array.prototype.slice.call(arguments);let o=[];for(let e=0;e<t.length;e++)"string"!=typeof t[e]?o.push(JSON.stringify(t[e])):o.push(t[e]);var e=o.join(" ");a.model.logger.push(e)},{log:function(){a.log(Array.prototype.slice.call(arguments)),this.addLog(arguments,"logs"),o&&t.log&&t.log.apply(t,arguments)},warn:function(){this.addLog(arguments,"warns"),o&&t.warn&&t.warn.apply(t,arguments)},error:function(){this.addLog(arguments,"errors"),o&&t.error&&t.error.apply(t,arguments)},info:function(e){this.addLog(arguments,"infos"),o&&t.info&&t.info.apply(t,arguments)},debug:function(e){o=e},saveLog:function(e){n=e},addLog:function(arguments,e){n&&r[e||"logs"].push(arguments)},logArray:function(){return r}}},Steps={LOADING:-1,LANDING:0,INSTALL:10,INSTALLLING:20,REGISTER:30,APP:40,INSTALL_COMPLETE:50,ALREADY_INSTALLED:60,VERIFIED:70};let refreshing=!1;var MobileModel=function(e){var a=this;a.params=e;const t=new BroadcastChannel("bob-channel");window.console=smartConsole(a,window.console),a.version=ko.observable("-"),a.state=ko.observable(null),a.verified=ko.observable(e.verified),a.loading=ko.observable(!0),a.serviceWorker=ko.observable(),a.serviceWorkerRegistration=ko.observable(),a.bobRegistration=ko.observable(null),a.step=ko.observable(0),a.bodyBackground=ko.observable(!1),a.debug=ko.observable(!1),a.deferredPrompt=ko.observable(null),a.installed=ko.observable(!1),a.alreadyInstalled=ko.observable(null),a.installable=ko.computed(function(){return utils.isApp()}),a.code=ko.observable(null),a.registered=ko.observable(null),a.notificationStatus=ko.observable(null),a.notificationToken=ko.observable(!1),a.position=ko.observable(null),a.positionStatus=ko.observable(null),a.notify=ko.observable({msg:"",level:""}),a.closeBanner=function(){a.notify({msg:"",level:""})},a.numberOfAlarms=ko.observable(0),a.alarms=ko.observableArray([]),a.closeMessage=function(){a.numberOfAlarms(0),a.alarms([])},a.invoked=ko.observable(!1),a.isSender=ko.computed(function(e){return a.state()&&""!==a.state().send_to}),a.error=function(e){a.notify({msg:e,level:"err"})},a.success=function(e){a.notify({msg:e,level:"success"})},a.alarm=function(e){a.notify({msg:e,level:"alarm"})},a.logger=ko.observableArray(),a.group=ko.computed(function(){var e=a.state();return e?e.send_to:""}),a.isPageActive=function(e){return this.step()===e},a.step.subscribe(function(e){}),a.notificationStatus.subscribe(function(e){}),a.numberOfAlarms.subscribe(function(e){0<e?utils.setBadge(e):utils.clearAppBadge()}),a.step.subscribe(function(e){switch(a.loading(!1),e){case Steps.LOADING:a.loading(!0);break;case Steps.LANDING:break;case Steps.INSTALL:case Steps.REGISTER:a.bodyBackground("install");break;case Steps.APP:a.bodyBackground("app"),a.checkStatus()}}),window.addEventListener("beforeinstallprompt",function(e){a.verified()||(e.preventDefault(),localStorage.removeItem("reg"),localStorage.removeItem("info"),a.deferredPrompt(e),a.bobRegistration(null),a.state(null),a.loading(!1),utils.isApp()?a.step(Steps.REGISTER):a.step(Steps.INSTALL))}),a.syncManager=ko.observable(),navigator.serviceWorker&&(navigator.serviceWorker.ready.then(e=>{a.serviceWorkerRegistration(e),a.serviceWorker(e.installing||e.active)}),navigator.getInstalledRelatedApps&&navigator.getInstalledRelatedApps().then(function(e){a.alreadyInstalled(0<e.length)})),t.onmessage=e=>{e.data.action?"setAppBadge"===e.data.action?a.numberOfAlarms(e.data.value):"check_status"===e.data.action?utils.checkStatus():"clearAppBadge"===e.data.action?(utils.closeNotification(),a.numberOfAlarms(0)):"refresh_status"===e.data.action&&a.checkStatus():e.data.notification?(a.alarm(e.data.notification.message),a.alarms().push(e.data.notification.message),a.numberOfAlarms(a.numberOfAlarms()+1),utils.checkStatus()):e.data.message?"ERROR"===e.data.level?a.error(e.data.message):"INFO"===e.data.level&&a.success(e.data.message):e.data.version&&a.version(e.data.version)},a.state.subscribe(function(e){a.saveState(e)}),waitInstalled=function(){navigator.getInstalledRelatedApps().then(function(e){0===e.length?setTimeout(waitInstalled,2e3):(a.step(Steps.INSTALL_COMPLETE),location.reload())})},a.install=function(){a.step(Steps.INSTALLLING),a.deferredPrompt()&&(a.deferredPrompt().prompt(),a.deferredPrompt().userChoice.then(function(e){"accepted"===e.outcome?navigator.getInstalledRelatedApps?waitInstalled():setTimeout(()=>{a.installed(!0)},1e4):a.installing(!1),a.deferredPrompt(null)}))},a.update=function(){let e=utils.loadVersionBrowser(navigator.userAgent);var t={token:a.bobRegistration().token,data:a.params.secret,code:a.params.code,ua_string:navigator.userAgent,browser:e.name.toUpperCase(),...a.notificationToken()};axios.post("/pwa/update/",t).then(function(e){localStorage.setItem("reg",window.btoa(JSON.stringify(e.data))),a.success("Update completed..."),a.step(3),location.reload()}).catch(function(e){Sentry.captureException(e),a.error("Errore")})},a.register=function(){let e=utils.loadVersionBrowser(navigator.userAgent);var t={data:a.params.secret,code:a.code(),ua_string:navigator.userAgent,browser:e.name.toUpperCase(),...a.notificationToken()};axios.post("/pwa/register/",t).then(function(e){localStorage.setItem("reg",window.btoa(JSON.stringify(e.data))),a.success("Registration Completed..."),a.step(3),location.reload()}).catch(function(e){Sentry.captureException(e),a.error("Errore")})},a.saveState=function(){localStorage.setItem("info",window.btoa(JSON.stringify(a.state())))},a.loadState=function(){try{var t=JSON.parse(window.atob(localStorage.getItem("info")))}catch(e){t={}}a.state(t)},a.askForNotification=function(){a.serviceWorkerRegistration()&&a.serviceWorkerRegistration().pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:utils.urlBase64ToUint8Array(a.params.key)}).then(function(e){var t=e.endpoint.split("/"),t=t[t.length-1],t={p256dh:btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("p256dh")))),auth:btoa(String.fromCharCode.apply(null,new Uint8Array(e.getKey("auth")))),registration_id:t};a.notificationToken(t),a.notificationStatus(Notification.permission)},function(){a.notificationStatus(Notification.permission)})},a.askForPosition=async function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){a.position(e),a.positionStatus("ok")},function(){a.position(null),a.positionStatus("ok")},{maximumAge:3e5,timeout:1/0}):a.error("Geolocation is not supported by your browser")},a.checkNotification=function(){},a.checkPosition=function(){navigator.geolocation.getCurrentPosition(function(e){a.position(e),a.positionStatus("ok")},function(){a.positionStatus("ok"),a.position(null)})},updatePosition=setInterval(3e4,function(){a.checkPosition()}),a.checkStatus=function(){a.loadRegistration();var e=a.bobRegistration();axios.post("/pwa/status/",{token:e.token,code:e.code}).then(function(e){a.state(e.data),e.data.selected||a.error("App not enabled")}).catch(function(e){a.state({}),a.askForNotification(),a.step(Steps.REGISTER)})},a.loadRegistration=function(){var o;try{o=JSON.parse(window.atob(localStorage.getItem("reg")))}catch(e){o=null}return a.bobRegistration(o),new Promise((e,t)=>{(o?e:t)(o)})};var o=0;a.debug.subscribe(function(e){localStorage.setItem("debug",e),a.code(a.params.code)}),a.timerId=ko.observable(null),a.buttonImage=ko.computed(function(){return a.invoked()?a.params.static+"pwa/button/alarmed.png":a.timerId()?a.params.static+"pwa/button/pressed.gif":a.params.static+"pwa/button/default.png"}),a.canRegister=ko.computed(function(){return a.serviceWorker()&&a.notificationToken()}),a.canBeInstalled=ko.computed(function(){return a.serviceWorker()&&a.deferredPrompt()},a),a.canSendHelp=ko.computed(function(){return a.isSender()&&a.bobRegistration()}),a.countdown=ko.observable(!1),a.clickDebug=function(){o++,a.debug()?(a.debug(!1),o=0):7<=o&&(o=0,a.debug(!0))},a.start=function(){if(!navigator.serviceWorker){var e="Sorry. This device does not support Bob technology. ";return a.error(e),void Sentry.captureMessage(e)}a.verified()&&utils.isBrowser()?a.step(Steps.VERIFIED):(utils.iOS(),a.debug(JSON.parse(localStorage.getItem("debug"))),utils.isBrowser()?(a.serviceWorker.subscribe(function(e){a.alreadyInstalled.subscribe(function(e){e?a.step(Steps.ALREADY_INSTALLED):a.step(Steps.INSTALL)})}),navigator.serviceWorker.register("/pwa/serviceworker.js",{scope:"/pwa/"})):utils.isApp()?(a.serviceWorker.subscribe(function(e){e?(a.positionStatus.subscribe(function(e){a.askForNotification()}),a.askForPosition()):navigator.serviceWorker.register("/pwa/serviceworker.js",{scope:"/pwa/"})}),a.loadRegistration().then(function(){a.checkStatus(),a.step(Steps.APP)}).catch(()=>{a.serviceWorker.valueHasMutated(),a.step(Steps.REGISTER)})):a.error("Unknown displayMode"))},a.help=function(){var e,t;null!==a.timerId()&&(a.touchEndHandler(),e=a.bobRegistration(),t=a.position(),t={token:e.token,code:e.code,location:t},axios.post("/pwa/help/",t).then(e=>{a.invoked(!0),a.success("Sent")}).catch(e=>{Sentry.captureException(e),e.response&&a.error(e.response.error)}))},a.touchStartHandler=function(){a.timerId(setInterval(a.help,2e3))},a.touchEndHandler=function(){clearInterval(a.timerId()),a.timerId(null)}};window.addEventListener("load",function(){let t;var e;window.__init__&&(e=atob(document.getElementById("key").getAttribute("content")),window.__init__({msk:e}).then(function(){var e=JSON.parse(atob(document.getElementById("params").getAttribute("content")));Sentry.setTag("pwa",!0),Sentry.setTag("pwa.key",e.secret),t=new MobileModel(e),ko.applyBindings(t),t.start()}))});
