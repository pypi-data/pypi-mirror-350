# SensoryLAB Async Microservice Detector

## üì∑ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö –∏ –≤–∏–¥–µ–æ (YOLOv8)

---

## –û–ø–∏—Å–∞–Ω–∏–µ

**Async Microservice Detector** ‚Äî —ç—Ç–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π backend-—Å–µ—Ä–≤–∏—Å, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π REST –∏ WebSocket API –¥–ª—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–µ–π —Å–µ–º–µ–π—Å—Ç–≤–∞ YOLOv8. –°–µ—Ä–≤–∏—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

- **–û–±—Ä–∞–±–æ—Ç–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –≤–∏–¥–µ–æ** —á–µ—Ä–µ–∑ HTTP upload –∏–ª–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –ø—É—Ç–∏ (–∏–∑ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π).
- **–ü–æ—Ç–æ–∫–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑** –≤–∏–¥–µ–æ–∫–∞–¥—Ä–æ–≤ —á–µ—Ä–µ–∑ WebSocket.
- **–ì–æ—Ä—è—á—É—é —Å–º–µ–Ω—É –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π**.
- **–ë–µ–∑–æ–ø–∞—Å–Ω—É—é —Ä–∞–±–æ—Ç—É —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π** (path traversal protection).
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π –¥–µ–ø–ª–æ–π –≤ Docker**.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **FastAPI** ‚Äî –±—ã—Å—Ç—Ä—ã–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π backend —Å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π OpenAPI –∏ Swagger UI.
- **YOLOv8 (Ultralytics)** ‚Äî –±—ã—Å—Ç—Ä–∞—è –∏ —Ç–æ—á–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤.
- **–ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî –ª–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –ø–∞–π–ø–ª–∞–π–Ω—ã, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—é.
- **–ú–æ–¥–µ–ª—å –∫—ç—à–∏—Ä—É–µ—Ç—Å—è** –≤ VRAM/RAM, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–≥—Ä—É–∑–∫–∞ –ø–æ —Ç–∞–π–º–∞—É—Ç—É.
- **–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º** ‚Äî –∞–Ω–∞–ª–∏–∑ —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π.
- **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** ‚Äî –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ –∏ backend-–¥–µ—Ç–µ–∫—Ç–æ—Ä—ã.

#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞

```mermaid
flowchart TD
  A[–ö–ª–∏–µ–Ω—Ç REST/WS] -->|HTTP upload –∏–ª–∏ path| B[FastAPI —Å–µ—Ä–≤–µ—Ä]
  B --> C[–ú–µ–Ω–µ–¥–∂–µ—Ä –∫—ç—à–∞ –º–æ–¥–µ–ª–µ–π]
  C --> D[YOLOv8Wrapper –∏–Ω—Ñ–µ—Ä–µ–Ω—Å]
  B -->|upload| E[–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ñ–∞–π–ª–æ–≤]
  B -->|analyze by path| F[FILES_PATH]
  D --> G[–†–µ–∑—É–ª—å—Ç–∞—Ç: –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤]
  B --> H[WebSocket –∞–Ω–∞–ª–∏–∑]
  H --> D
  C -->|LRU Eviction| X[Unload VRAM/RAM]
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
```bash
git clone http://10.10.0.20:3000/m.chui/Yolo.git
cd Yolo
```
### 2. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (—Å–º. –Ω–∏–∂–µ)
```bash
docker-compose up --build
```
### 3. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
| --------------------- | ------------------------------------------------------- | -------------------------- |
| `FILES_PATH` | –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –¥–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ | `/mnt/nfs/servers` |
| `WEIGHTS_DIR` | –ö–∞—Ç–∞–ª–æ–≥ —Å YOLO –≤–µ—Å–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ | `/app/weights` |
| `DEFAULT_MODEL_NAME` | –ò–º—è –º–æ–¥–µ–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–±–µ–∑ .pt) | `yolov8s` |
| `MODEL_CACHE_TIMEOUT_SEC` | –¢–∞–π–º–∞—É—Ç –ø—Ä–æ—Å—Ç–æ—è –º–æ–¥–µ–ª–∏ –≤ –∫—ç—à–µ (—Å–µ–∫) | `600` |

**–ü—Ä–∏–º–µ—Ä docker-compose.yaml:**
```yaml
version: '3.8'
services:
  yolo:
    build: .
    ports:
      - "8000:8000"
    environment:
      - FILES_PATH=/data
      - WEIGHTS_DIR=/app/weights
      - DEFAULT_MODEL_NAME=yolov8s
      - MODEL_CACHE_TIMEOUT_SEC=600
    volumes:
      - /mnt/nfs/servers:/data:ro   # –ú–∞—É–Ω—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
      - ./src/sensory_detector/weights:/app/weights
```

## üßë‚Äçüíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

### Swagger/OpenAPI

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π Swagger UI:  
[http://localhost:8000/docs](http://localhost:8000/docs)

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

#### 1. –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (upload)
```bash
curl -X POST "http://localhost:8000/api/analyze/auto" \
  -F "file=@test.jpg" \
  -F "model_name=yolov8s"

#### 2. –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ (upload)
curl -X POST "http://localhost:8000/api/analyze/auto" \
  -F "file=@test.avi" \
  -F "model_name=yolov8s"
#### 3. –ê–Ω–∞–ª–∏–∑ –ø–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –ø—É—Ç–∏
curl -X POST "http://localhost:8000/api/analyze/auto" \
  -F "path=/data/test.jpg" \
  -F "model_name=yolov8s"
```
#### 4. WebSocket –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞

```python
import websockets, cv2, numpy as np, asyncio, json

async def ws_demo():
    uri = "ws://localhost:8000/ws/analyze?model_name=yolov8s"
    img = np.zeros((128, 128, 3), np.uint8)
    _, jpg = cv2.imencode(".jpg", img)
    async with websockets.connect(uri) as ws:
        await ws.send(jpg.tobytes())
        resp = await ws.recv()
        print(json.loads(resp))

asyncio.run(ws_demo())
```

## üì¶ –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
```json
{
  "model_name": "yolov8s",
  "detections": [
    {
      "index": 0,
      "timestamp": 0.0,
      "detections": [
        {
          "index": 0,
          "object_name": "person",
          "confidence": 0.93,
          "bounding_box": {
            "x1": 34.3, "y1": 41.2, "x2": 100.2, "y2": 200.8
          }
        }
      ]
    }
  ]
}
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **Path Traversal Protection** ‚Äî —Å–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã, –Ω–∞—Ö–æ–¥—è—â–∏–µ—Å—è –≤ `FILES_PATH`.
- **Upload Validation** ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è MIME-—Ç–∏–ø, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è/–≤–∏–¥–µ–æ.
- **–†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Docker volume —Å read-only –¥–æ—Å—Ç—É–ø–æ–º –¥–ª—è –¥–∞–Ω–Ω—ã—Ö.

---

## ‚öôÔ∏è –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–µ–ø–ª–æ—è

- **GPU**: –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ nvidia-docker (`--gpus=all`).
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –∑–∞ reverse proxy (–Ω–∞–ø—Ä–∏–º–µ—Ä, nginx –∏–ª–∏ traefik).
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ stdout/stderr –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –î–æ–±–∞–≤—å—Ç–µ Prometheus/Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞–≥—Ä—É–∑–∫–∏.
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π**: –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π `.pt` –≤ `WEIGHTS_DIR` –∏ –≤—ã–∑–æ–≤–∏—Ç–µ `/api/available_models`.

---

## üõ†Ô∏è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Ç–µ—Å—Ç—ã

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
pytest tests/
### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –±–µ–∑ Docker

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```
–ó–∞–ø—É—Å–∫ dev-—Å–µ—Ä–≤–µ—Ä–∞:
```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```
---

## üìù –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–∏–Ω–≥

- –ü–∏—à–∏—Ç–µ –∫–æ–¥ —Å typing –∏ docstring.
- –°–æ–±–ª—é–¥–∞–π—Ç–µ PEP8.
- –û—Ñ–æ—Ä–º–ª—è–π—Ç–µ pull requests —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ –ø—É–±–ª–∏—á–Ω—ã–µ API.

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- Swagger UI: http://localhost:8000/docs
- OpenAPI: http://localhost:8000/openapi.json

---

## ü§ù –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

- [Ultralytics YOLOv8](https://github.com/ultralytics/ultralytics)
- [FastAPI](https://fastapi.tiangolo.com/)
- [pyAV](https://github.com/PyAV-Org/PyAV)

---

**–í–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞:**  
–°–æ–∑–¥–∞–π—Ç–µ issue –∏–ª–∏ –ø–∏—à–∏—Ç–µ –Ω–∞ team@example.com

---

**¬© 2025, SensoryLAB Team**
