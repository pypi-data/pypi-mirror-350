# GitHub Actions workflow: Rust + C++ (FastLanes)
# Save as .github/workflows/rust.yml

name: Rust

run-name: >-
  ${{ github.workflow }} on ${{ github.ref_name }} (#${{ github.run_number }})
  — ${{ github.event.pull_request.title || github.event.head_commit.message }}

on:
  push:
  pull_request:
    branches: [ "main", "dev" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ──────────────────────────────────────────────────────────────
  # 1️⃣  Format‑check
  # ──────────────────────────────────────────────────────────────
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Detect CPU count
        run: make detect-cpu | tee -a "$GITHUB_ENV"

      - name: Check Rust formatting
        working-directory: rust
        run: cargo fmt -- --check

  # ──────────────────────────────────────────────────────────────
  # 2️⃣  Build & test (with Clang → libstdc++)
  # ──────────────────────────────────────────────────────────────
  build:
    needs: [ fmt ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Detect CPU count
        run: make detect-cpu | tee -a "$GITHUB_ENV"

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target/debug/deps
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Install LLVM
        uses: ./.github/actions/install-llvm

      - name: Install C++ deps
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential pkg-config \
                                 libc++-dev libc++abi-dev

      - name: Build & run Rust example
        env:
          CC: clang
          CXX: clang++
        run: make -j $BUILD_THREADS run-rust-example

      - name: Run Rust tests
        env:
          CC: clang
          CXX: clang++
        run: |
          cd rust
          cargo test -- --test-threads $BUILD_THREADS

      - name: Dry‑run publish check
        env:
          CC: clang
          CXX: clang++
        run: make -j $BUILD_THREADS dry-run-rust

      # ─────────────────────────────────────────────
      # 🔍 Extra diagnostics for linking issues
      # ─────────────────────────────────────────────
      - name: Re‑build with verbose linker flags
        if: ${{ failure() }}
        working-directory: rust
        env:
          CC: clang
          CXX: clang++
          CARGO_TERM_COLOR: always
        run: |
          cargo clean
          cargo build -vv           # prints every -L and -l flag

      - name: Locate any fastlanes artefacts
        if: ${{ failure() }}
        run: |
          echo 'Searching for fastlanes artefacts …'
          find rust/target -name 'libfastlanes.*' -or -name '*fastlanes*' | head || true

      - name: Upload fastlanes artefact (optional)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: fastlanes-build-dir
          path: |
            rust/target/**/build
            !**/*.o

  # ──────────────────────────────────────────────────────────────
  # 3️⃣  (Optional) Deploy docs or other post‑build steps…
  # ──────────────────────────────────────────────────────────────
  # deploy-docs:
  #   needs: build
  #   runs-on: ubuntu-latest
  #   steps:
  #     …
