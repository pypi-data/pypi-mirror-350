"use strict";(self.webpackChunk_jupyter_collaboration_extension=self.webpackChunk_jupyter_collaboration_extension||[]).push([[393],{6393:(e,t,n)=>{n.r(t),n.d(t,{Collaborator:()=>C,CollaboratorsBody:()=>y,CollaboratorsPanel:()=>b,DefaultIconRenderer:()=>z,IUserMenu:()=>s,RendererUserMenu:()=>P,UserInfoBody:()=>q,UserInfoPanel:()=>J,UserMenu:()=>N,UsersItem:()=>V,remoteUserCursors:()=>S,showSharedLinkDialog:()=>B});var r=n(7262);const s=new r.Token("@jupyter/collaboration:IUserMenu");var a=n(9560),o=n(484),i=n(4602),l=n(5256),c=n(3345),d=n.n(c);const u="jp-CollaboratorsList",h="jp-Collaborator",m="jp-CollaboratorHeader",p="jp-CollaboratorHeaderCollapser",_="jp-ClickableCollaborator",f="jp-CollaboratorIcon",g="jp-CollaboratorFiles",v="jp-CollaboratorFile";class b extends l.Panel{constructor(e,t,n,r){super({}),this._onAwarenessChanged=()=>{const e=this._awareness.getStates(),t=new Map;e.forEach(((e,n)=>{if(this._currentUser.isReady&&e.user&&e.user.username!==this._currentUser.identity.username){const n=`${e.user.username}-${e.current||"no-current"}`;t.has(n)||t.set(n,e)}})),this._collaboratorsChanged.emit(Array.from(t.values()))},this._collaboratorsChanged=new i.Signal(this),this._awareness=t,this._currentUser=e,this.addClass("jp-CollaboratorsPanel"),this.addWidget(a.ReactWidget.create(d().createElement(y,{fileopener:n,collaboratorsChanged:this._collaboratorsChanged,docRegistry:r}))),this._awareness.on("change",this._onAwarenessChanged)}}function y(e){const[t,n]=(0,c.useState)([]);return e.collaboratorsChanged.connect(((e,t)=>{n(t)})),d().createElement("div",{className:u},t.map((t=>{const n=`${t.user.username}-${t.current||"no-current"}`;return d().createElement(C,{key:n,collaborator:t,fileopener:e.fileopener,docRegistry:e.docRegistry})})))}function C(e){const[t,n]=(0,c.useState)(!1),{collaborator:r,fileopener:s}=e;let a="";if(r.current){const e=r.current.split(":");a=`${e[1]}`}const i=r.documents||[],l=i.map((t=>{var n,r;const s=null===(r=null===(n=e.docRegistry)||void 0===n?void 0:n.getFileTypesForPath(t))||void 0===r?void 0:r.filter((e=>void 0!==e.icon)),a=(null==s?void 0:s.length)?s[0].icon:o.fileIcon,i=(null==s?void 0:s.length)?s[0].iconClass:void 0;return{filename:t.length>40?t.slice(0,10).concat("â€¦").concat(t.slice(t.length-15)):t,fileLocation:t,icon:a,iconClass:i}}));return d().createElement("div",{className:h},d().createElement("div",{className:l.length?`${_} ${m}`:m,onClick:i?()=>{l.length&&n(!t)}:void 0},d().createElement(o.LabIcon.resolveReact,{icon:o.caretDownIcon,className:p+(t?" jp-mod-expanded":""),tag:"div"}),d().createElement("div",{className:f,style:{backgroundColor:r.user.color}},d().createElement("span",null,r.user.initials)),d().createElement("span",null,r.user.display_name)),d().createElement("div",{className:`${g} jp-DirListing`,style:t?{}:{display:"none"}},d().createElement("ul",{className:"jp-DirListing-content"},l.map((e=>d().createElement("li",{className:"jp-DirListing-item "+(e.fileLocation===a?`${v} jp-mod-running`:v),key:e.filename,onClick:()=>s(e.fileLocation)},d().createElement(o.LabIcon.resolveReact,{icon:e.icon,iconClass:e.iconClass,tag:"span",className:"jp-DirListing-itemIcon",stylesheet:"listing"}),d().createElement("span",{className:"jp-DirListing-itemText",title:e.fileLocation},e.filename)))))))}var k=n(195),w=n(5024),j=n(2206);const x=k.Facet.define({combine:e=>e[e.length-1]}),I=w.EditorView.baseTheme({".jp-remote-cursor":{borderLeft:"1px solid black",marginLeft:"-1px"},".jp-remote-cursor.jp-mod-primary":{borderLeftWidth:"2px"},".jp-remote-selection":{opacity:.5},".cm-tooltip":{border:"none"},".cm-tooltip .jp-remote-userInfo":{color:"var(--jp-ui-inverse-font-color0)",padding:"0px 2px"}}),E=k.Annotation.define();class M{constructor(e,t){this.style=e,this.marker=t}draw(){const e=this.marker.draw();for(const[t,n]of Object.entries(this.style))e.style[t]=n;return e}eq(e){return this.marker.eq(e.marker)&&r.JSONExt.deepEqual(this.style,e.style)}update(e,t){for(const[t,n]of Object.entries(this.style))e.style[t]=n;return this.marker.update(e,t.marker)}}const L=(0,w.layer)({above:!0,markers(e){const{awareness:t,ytext:n}=e.state.facet(x),r=n.doc,s=[];return t.getStates().forEach(((a,o)=>{var i,l,c;if(o===t.doc.clientID)return;const d=a.cursors;for(const t of null!=d?d:[]){if(!(null==t?void 0:t.anchor)||!(null==t?void 0:t.head))return;const o=(0,j.createAbsolutePositionFromRelativePosition)(t.anchor,r),d=(0,j.createAbsolutePositionFromRelativePosition)(t.head,r);if((null==o?void 0:o.type)!==n||(null==d?void 0:d.type)!==n)return;const u=null===(i=t.primary)||void 0===i||i?"jp-remote-cursor jp-mod-primary":"jp-remote-cursor",h=k.EditorSelection.cursor(d.index,d.index>o.index?-1:1);for(const t of w.RectangleMarker.forRange(e,u,h))s.push(new M({borderLeftColor:null!==(c=null===(l=a.user)||void 0===l?void 0:l.color)&&void 0!==c?c:"black"},t))}})),s},update:(e,t)=>!!e.transactions.find((e=>e.annotation(E))),class:"jp-remote-cursors"}),R=(0,w.hoverTooltip)(((e,t)=>{var n;const{awareness:r,ytext:s}=e.state.facet(x),a=s.doc;for(const[e,o]of r.getStates())if(e!==r.doc.clientID)for(const e of null!==(n=o.cursors)&&void 0!==n?n:[]){if(!(null==e?void 0:e.head))continue;const n=(0,j.createAbsolutePositionFromRelativePosition)(e.head,a);if((null==n?void 0:n.type)===s&&n.index-3<=t&&t<=n.index+3)return{pos:n.index,above:!0,create:()=>{var e,t,n,r;const s=document.createElement("div");return s.classList.add("jp-remote-userInfo"),s.style.backgroundColor=null!==(t=null===(e=o.user)||void 0===e?void 0:e.color)&&void 0!==t?t:"darkgrey",s.textContent=null!==(r=null===(n=o.user)||void 0===n?void 0:n.display_name)&&void 0!==r?r:"Anonymous",{dom:s}}}}return null}),{hideOn:(e,t)=>!!e.annotation(E),hoverTime:0}),A=(0,w.layer)({above:!1,markers(e){const{awareness:t,ytext:n}=e.state.facet(x),r=n.doc,s=[];return t.getStates().forEach(((a,o)=>{var i,l,c;if(o===t.doc.clientID)return;const d=a.cursors;for(const t of null!=d?d:[]){if(null===(i=t.empty)||void 0===i||i||!(null==t?void 0:t.anchor)||!(null==t?void 0:t.head))return;const o=(0,j.createAbsolutePositionFromRelativePosition)(t.anchor,r),d=(0,j.createAbsolutePositionFromRelativePosition)(t.head,r);if((null==o?void 0:o.type)!==n||(null==d?void 0:d.type)!==n)return;const u="jp-remote-selection";for(const t of w.RectangleMarker.forRange(e,u,k.EditorSelection.range(o.index,d.index)))s.push(new M({backgroundColor:null!==(c=null===(l=a.user)||void 0===l?void 0:l.color)&&void 0!==c?c:"black"},t))}})),s},update:(e,t)=>!!e.transactions.find((e=>e.annotation(E))),class:"jp-remote-selections"}),D=w.ViewPlugin.fromClass(class{constructor(e){this.editorAwareness=e.state.facet(x),this._listener=({added:t,updated:n,removed:r})=>{t.concat(n).concat(r).findIndex((e=>e!==this.editorAwareness.awareness.doc.clientID))>=0&&e.dispatch({annotations:[E.of([])]})},this.editorAwareness.awareness.on("change",this._listener)}destroy(){this.editorAwareness.awareness.off("change",this._listener)}update(e){var t;if(!e.docChanged&&!e.selectionSet)return;const{awareness:n,ytext:s}=this.editorAwareness,a=n.getLocalState();if(a){const o=e.view.hasFocus&&e.view.dom.ownerDocument.hasFocus(),i=e.state.selection,l=new Array;if(o&&i){for(const e of i.ranges){const t=e===i.main,n=(0,j.createRelativePositionFromTypeIndex)(s,e.anchor),r=(0,j.createRelativePositionFromTypeIndex)(s,e.head);l.push({anchor:n,head:r,primary:t,empty:e.empty})}if(!a.cursors||l.length>0){const e=null===(t=a.cursors)||void 0===t?void 0:t.map((e=>({...e,anchor:(null==e?void 0:e.anchor)?(0,j.createRelativePositionFromJSON)(e.anchor):null,head:(null==e?void 0:e.head)?(0,j.createRelativePositionFromJSON)(e.head):null})));r.JSONExt.deepEqual(l,e)||n.setLocalStateField("cursors",l)}}}}},{provide:()=>[I,L,A,R,(0,w.tooltips)({position:"absolute",parent:document.body})]});function S(e){return[x.of(e),D]}var U=n(4873);class P extends l.MenuBar.Renderer{constructor(e){super(),this._user=e}renderItem(e){const t=this.createItemClass(e),n=this.createItemDataset(e),r=this.createItemARIA(e);return U.h.li({className:t,dataset:n,tabindex:"0",onfocus:e.onfocus,...r},this._createUserIcon(),this.renderLabel(e),this.renderIcon(e))}renderLabel(e){const t=this.formatLabel(e);return U.h.div({className:"lm-MenuBar-itemLabel jp-MenuBar-label"},t)}_createUserIcon(){return this._user.isReady&&this._user.identity.avatar_url?U.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-imageIcon"},U.h.img({src:this._user.identity.avatar_url})):this._user.isReady?U.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon",style:{backgroundColor:this._user.identity.color}},U.h.span({},this._user.identity.initials)):U.h.div({className:"lm-MenuBar-itemIcon jp-MenuBar-anonymousIcon"},o.userIcon)}}class N extends l.Menu{constructor(e){super(e)}}var T=n(1689),F=n(4918);async function B({translator:e}){const t=(null!=e?e:F.nullTranslator).load("collaboration"),n=T.PageConfig.getToken(),r=new URL(T.URLExt.normalize(T.PageConfig.getUrl({workspace:T.PageConfig.defaultWorkspace})));return(0,a.showDialog)({title:t.__("Share Jupyter Server Link"),body:new H(r.toString(),n,""!==T.PageConfig.getOption("hubUser"),t),buttons:[a.Dialog.cancelButton(),a.Dialog.okButton({label:t.__("Copy Link"),caption:t.__("Copy the link to the Jupyter Server")})]})}class H extends l.Widget{constructor(e,t,n,r){super(),this._url=e,this._token=t,this._behindHub=n,this._trans=r,this._tokenCheckbox=null,this.onTokenChange=e=>{const t=e.target;this.updateContent(null==t?void 0:t.checked)},this._warning=document.createElement("div"),this.populateBody(this.node),this.addClass("jp-shared-link-body")}getValue(){var e;if(!0===(null===(e=this._tokenCheckbox)||void 0===e?void 0:e.checked)){const e=new URL(this._url);return e.searchParams.set("token",this._token),e.toString()}return this._url}onAfterAttach(e){var t;super.onAfterAttach(e),null===(t=this._tokenCheckbox)||void 0===t||t.addEventListener("change",this.onTokenChange)}onBeforeDetach(e){var t;null===(t=this._tokenCheckbox)||void 0===t||t.removeEventListener("change",this.onTokenChange),super.onBeforeDetach(e)}updateContent(e){this._warning.innerHTML="";const t=this.node.querySelector("input[readonly]");if(e){if(t){const e=new URL(this._url);e.searchParams.set("token",this._token.slice(0,5)),t.value=e.toString()+"â€¦"}this._warning.appendChild(document.createElement("h3")).textContent=this._trans.__("Security warning!"),this._warning.insertAdjacentText("beforeend",this._trans.__("Anyone with this link has full access to your notebook server, including all your files!")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._warning.insertAdjacentText("beforeend",this._trans.__("Please be careful who you share it with.")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._behindHub?(this._warning.insertAdjacentText("beforeend",this._trans.__("They will be able to access this server AS YOU.")),this._warning.insertAdjacentHTML("beforeend","<br>"),this._warning.insertAdjacentText("beforeend",this._trans.__("To revoke access, go to File -> Hub Control Panel, and restart your server."))):this._warning.insertAdjacentText("beforeend",this._trans.__("Currently, there is no way to revoke access other than shutting down your server."))}else t&&(t.value=this._url),this._behindHub?this._warning.insertAdjacentText("beforeend",this._trans.__("Only users with `access:servers` permissions for this server will be able to use this link.")):this._warning.insertAdjacentText("beforeend",this._trans.__("Only authenticated users will be able to use this link."))}populateBody(e){if(e.insertAdjacentHTML("afterbegin",`<input readonly value="${this._url}">`),this._token){const t=e.appendChild(document.createElement("label"));t.insertAdjacentHTML("beforeend",'<input type="checkbox">'),this._tokenCheckbox=t.firstChild,t.insertAdjacentText("beforeend",this._trans.__("Include token in URL")),e.insertAdjacentElement("beforeend",this._warning),this.updateContent(!1)}}}var O=n(186);function W(e){const{userManager:t,onClick:n}=e,[r,s]=(0,c.useState)(t.identity);return(0,c.useEffect)((()=>{const e=()=>{s(t.identity)};return t.userChanged.connect(e),()=>{t.userChanged.disconnect(e)}}),[t]),d().createElement("div",{title:r.display_name,className:"jp-UserInfo-Icon",style:{backgroundColor:r.color},onClick:n},d().createElement("span",null,r.initials))}class $ extends o.ReactWidget{constructor(e){super(),this._onChange=(e,t)=>{var n;const r=(null===(n=this._userManager.permissions)||void 0===n?void 0:n.updatable_fields)||[];(null==r?void 0:r.includes(t))&&(this._userUpdate[t]=e.target.value)},this._userUpdate={},this._userManager=e.userManager}getValue(){return this._userUpdate}render(){var e;const t=this._userManager.identity;if(!t)return d().createElement("div",{className:"jp-UserInfo-Details"},"Error loading user info");const n=(null===(e=this._userManager.permissions)||void 0===e?void 0:e.updatable_fields)||[];return d().createElement("div",{className:"jp-UserInfo-Details"},Object.keys(t).map((e=>{const r=`jp-UserInfo-Value-${e}`;return d().createElement("div",{key:e,className:"jp-UserInfo-Field"},d().createElement("label",{htmlFor:r},e),d().createElement("input",{type:"text",name:e,id:r,onInput:t=>this._onChange(t,e),defaultValue:t[e],disabled:!(null==n?void 0:n.includes(e))}))})))}}class J extends l.Panel{constructor(e){super({}),this.addClass("jp-UserInfoPanel"),this._profile=e.userManager,this._body=null,this._profile.isReady?(this._body=new q({userManager:this._profile,trans:e.trans}),this.addWidget(this._body),this.update()):this._profile.ready.then((()=>{this._body=new q({userManager:this._profile,trans:e.trans}),this.addWidget(this._body),this.update()})).catch((e=>console.error(e)))}}class q extends a.ReactWidget{constructor(e){super(),this.onClick=()=>{this._userManager.identity&&(0,a.showDialog)({body:new $({userManager:this._userManager}),title:this._trans.__("User Details")}).then((async e=>{if(e.button.accept)try{const t=O.ServerConnection.makeSettings(),n=T.URLExt.join(t.baseUrl,"/api/me"),r={method:"PATCH",body:JSON.stringify(e.value)};let s;try{s=await O.ServerConnection.makeRequest(n,r,t)}catch(e){throw new O.ServerConnection.NetworkError(e)}if(!s.ok){const e=this._trans.__("Failed to update user data");throw new Error(e)}this._userManager.refreshUser()}catch(e){console.error(e)}}))},this._userManager=e.userManager,this._trans=e.trans}get user(){return this._userManager}set user(e){this._userManager=e,this.update()}render(){return c.createElement("div",{className:"jp-UserInfo-Container"},c.createElement(W,{userManager:this._userManager,onClick:this.onClick}))}}class V extends c.Component{constructor(e){var t;super(e),this._awarenessChange=()=>{var e;const t=null===(e=this._model)||void 0===e?void 0:e.sharedModel.awareness.getStates(),n=[];t&&t.forEach(((e,t)=>{e.user&&n.push({userId:t,userData:e.user})})),this.setState((e=>({...e,usersList:n})))},this._model=e.model,this._iconRenderer=null!==(t=e.iconRenderer)&&void 0!==t?t:null,this.state={usersList:[]}}static createWidget(e){return o.ReactWidget.create(c.createElement(V,{...e}))}componentDidMount(){var e;null===(e=this._model)||void 0===e||e.sharedModel.awareness.on("change",this._awarenessChange),this._awarenessChange()}filterDuplicated(e){var t;const n=[],r=new Set;for(const s of e)(null===(t=null==s?void 0:s.userData)||void 0===t?void 0:t.username)&&!r.has(s.userData.username)&&(r.add(s.userData.username),n.push(s));return n}render(){var e;const t=null!==(e=this._iconRenderer)&&void 0!==e?e:z;return c.createElement("div",{className:"jp-toolbar-users-item"},this.filterDuplicated(this.state.usersList).map((e=>{if(this._model&&e.userId!==this._model.sharedModel.awareness.clientID)return t({user:e,model:this._model})})))}}function z(e){let t;const{user:n,model:r,...s}=e,a=(0,o.classes)("lm-MenuBar-itemIcon",e.className||"");return t=n.userData.avatar_url?c.createElement("div",{...s,key:n.userId,title:n.userData.display_name,className:(0,o.classes)(a,"jp-MenuBar-imageIcon")},c.createElement("img",{src:n.userData.avatar_url,alt:""})):c.createElement("div",{...s,key:n.userId,title:n.userData.display_name,className:(0,o.classes)(a,"jp-MenuBar-anonymousIcon"),style:{backgroundColor:n.userData.color}},c.createElement("span",null,n.userData.initials)),t}}}]);